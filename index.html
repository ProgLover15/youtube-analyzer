<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>YouTube 視聴習慣アナライザー</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --background-color: #121212; --surface-color: #1e1e1e;
            --primary-text-color: #ffffff; --secondary-text-color: #aaaaaa;
            --accent-color: #ff0000; --border-color: #333333;
            --button-blue-color: #3ea6ff; --error-color: #f44336;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; background-color: var(--background-color); color: var(--primary-text-color); padding: 2rem; }
        .hidden { display: none !important; }
        
        /* Stats Dashboard */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--surface-color); padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid var(--border-color); }
        .stat-card h3 { font-size: 2rem; margin-bottom: 0.5rem; }

        /* Filter Controls */
        .controls-section { background: var(--surface-color); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; }
        .slider-group { display: flex; align-items: center; gap: 1rem; margin: 1rem 0; }
        input[type="range"] { flex: 1; accent-color: var(--button-blue-color); }

        /* Action Bar */
        .action-bar { display: flex; justify-content: space-between; align-items: center; background: #000; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        
        /* Grid */
        .channel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; }
        .card { background: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; position: relative; }
        .card img { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 10px; }
        .card-checkbox { position: absolute; top: 10px; left: 10px; transform: scale(1.3); }

        .progress-bar-bg { background: #333; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .progress-bar-fill { background: var(--button-blue-color); width: 0%; height: 100%; transition: width 0.3s; }
        .btn { padding: 8px 16px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; }
        .btn-primary { background: var(--button-blue-color); color: white; }
        .btn-danger { background: var(--error-color); color: white; }
    </style>
</head>
<body>
    <header style="text-align:center; margin-bottom:2rem;">
        <h1><i class="fab fa-youtube"></i> YouTube 視聴習慣アナライザー</h1>
    </header>

    <main style="max-width: 1200px; margin: 0 auto;">
        <div id="onboarding" class="hidden" style="text-align:center; padding: 3rem;">
            <a href="/auth/google" class="btn btn-primary" style="font-size:1.2rem; padding:1rem 2rem;">Googleでログイン</a>
        </div>

        <div id="results" class="hidden">
            <div class="stats-container">
                <div class="stat-card"><h3><span id="count-total">0</span></h3><p>登録チャンネル</p></div>
                <div class="stat-card"><h3><span id="count-inactive">0</span></h3><p>活動休止中</p></div>
                <div class="stat-card"><h3><span id="count-deleted">0</span></h3><p>解除済み</p></div>
                <div class="stat-card" style="display:flex; flex-direction:column; justify-content:center;">
                    <button id="startAnalysisBtn" class="btn btn-primary">分析を開始</button>
                    <div id="progress-area" class="hidden">
                        <div class="progress-bar-bg"><div id="progress-fill" class="progress-bar-fill"></div></div>
                        <p id="progress-text" style="font-size:0.8rem; margin-top:5px;">0 / 0</p>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h4>活動休止の判定基準</h4>
                <div class="slider-group">
                    <input type="range" id="inactiveSlider" min="7" max="365" value="60">
                    <span id="sliderValue">60 日</span>
                </div>
            </div>

            <div class="action-bar">
                <label><input type="checkbox" id="selectAll"> すべて選択</label>
                <button id="bulkDeleteBtn" class="btn btn-danger">選択項目を解除</button>
            </div>

            <div id="channel-grid" class="channel-grid"></div>
        </div>
    </main>

    <script>
        let allChannels = [];
        let inactiveThreshold = 60;
        let deletedCount = 0;

        async function init() {
            try {
                const res = await fetch('/api/auth/status');
                if (res.ok) {
                    document.getElementById('results').classList.remove('hidden');
                    loadData();
                } else {
                    document.getElementById('onboarding').classList.remove('hidden');
                }
            } catch (e) { document.getElementById('onboarding').classList.remove('hidden'); }
        }

        async function loadData() {
            const res = await fetch('/api/all-channels');
            allChannels = await res.json();
            updateStats();
            render();
        }

        function updateStats() {
            const now = new Date();
            const inactive = allChannels.filter(c => {
                if (!c.isSubscribed || c.lastUploadDate === 'pending' || !c.lastUploadDate) return false;
                const diff = (now - new Date(c.lastUploadDate)) / (1000 * 60 * 60 * 24);
                return diff > inactiveThreshold;
            }).length;

            document.getElementById('count-total').innerText = allChannels.filter(c => c.isSubscribed).length;
            document.getElementById('count-inactive').innerText = inactive;
            document.getElementById('count-deleted').innerText = deletedCount;
        }

        function render() {
            const grid = document.getElementById('channel-grid');
            const now = new Date();
            grid.innerHTML = allChannels.filter(c => c.isSubscribed).map(ch => {
                const dayText = ch.lastUploadDate === 'pending' ? '未分析' : 
                                (ch.lastUploadDate ? `${Math.floor((now - new Date(ch.lastUploadDate))/(1000*60*60*24))}日前` : '投稿なし');
                return `
                <div class="card">
                    <input type="checkbox" class="card-checkbox chan-cb" data-id="${ch.subscriptionId}">
                    <img src="${ch.thumbnailUrl}">
                    <h4 style="font-size:0.9rem">${ch.channelName}</h4>
                    <p style="font-size:0.75rem; color:var(--secondary-text-color)">最終投稿: ${dayText}</p>
                </div>`;
            }).join('');
        }

        document.getElementById('startAnalysisBtn').onclick = async () => {
            const btn = document.getElementById('startAnalysisBtn');
            const prog = document.getElementById('progress-area');
            btn.classList.add('hidden');
            prog.classList.remove('hidden');

            let done = 0;
            for (let ch of allChannels) {
                if (ch.lastUploadDate !== 'pending') { done++; continue; }
                const res = await fetch('/api/analyze', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ channelId: ch.channelId })
                });
                const data = await res.json();
                ch.lastUploadDate = data.lastUploadDate;
                done++;
                document.getElementById('progress-fill').style.width = (done/allChannels.length*100) + '%';
                document.getElementById('progress-text').innerText = `${done} / ${allChannels.length}`;
                if (done % 5 === 0) { render(); updateStats(); }
            }
            render(); updateStats();
        };

        document.getElementById('inactiveSlider').oninput = (e) => {
            inactiveThreshold = e.target.value;
            document.getElementById('sliderValue').innerText = `${inactiveThreshold} 日`;
            updateStats();
        };

        document.getElementById('selectAll').onchange = (e) => {
            document.querySelectorAll('.chan-cb').forEach(cb => cb.checked = e.target.checked);
        };

        document.getElementById('bulkDeleteBtn').onclick = async () => {
            const selected = Array.from(document.querySelectorAll('.chan-cb:checked')).map(cb => cb.dataset.id);
            if (!selected.length || !confirm(`${selected.length}件の登録を解除しますか？`)) return;

            const res = await fetch('/api/subscriptions/bulk-delete', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ subscriptionIds: selected })
            });
            const data = await res.json();
            selected.forEach(id => {
                const ch = allChannels.find(c => c.subscriptionId === id);
                if (ch) ch.isSubscribed = false;
            });
            deletedCount += data.successCount;
            updateStats(); render();
            alert(`${data.successCount}件の解除に成功しました。`);
        };

        init();
    </script>
</body>
</html>

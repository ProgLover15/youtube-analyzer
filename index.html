<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 視聴習慣アナライザー</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --primary-text-color: #ffffff;
            --secondary-text-color: #aaaaaa;
            --accent-color: #ff0000;
            --border-color: #333333;
            --success-color: #4caf50;
            --error-color: #f44336;
            --button-blue-color: #3ea6ff;
            --button-gray-color: #5a5a5a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-image: linear-gradient(to top, #121212, #1a1a1a);
            color: var(--primary-text-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            color: var(--accent-color);
            font-size: 2em;
            margin-bottom: 5px;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .card {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--accent-color);
        }

        .card h3 {
            font-size: 1em;
            color: var(--secondary-text-color);
            margin-bottom: 5px;
        }

        .card p {
            font-size: 1.5em;
            font-weight: bold;
        }

        .channel-list {
            margin-top: 20px;
        }

        .channel-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        .channel-item.unsubscribed {
            opacity: 0.5;
        }

        .channel-item:last-child {
            border-bottom: none;
        }

        .channel-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .channel-info {
            flex-grow: 1;
        }

        .channel-info h4 {
            font-size: 1em;
            margin-bottom: 2px;
        }

        .channel-info p {
            font-size: 0.8em;
            color: var(--secondary-text-color);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-active { background-color: var(--success-color); }
        .status-inactive { background-color: var(--error-color); }
        .status-pending { background-color: var(--button-gray-color); }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-left: 20px;
        }

        button {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: var(--button-blue-color);
            color: var(--surface-color);
        }

        .btn-primary:hover {
            background-color: #61baff;
        }

        .btn-danger {
            background-color: var(--error-color);
            color: var(--primary-text-color);
        }

        .btn-danger:hover {
            background-color: #ff6f66;
        }

        .btn-secondary {
            background-color: var(--button-gray-color);
            color: var(--primary-text-color);
        }

        .btn-secondary:hover {
            background-color: #7d7d7d;
        }

        #login-section {
            text-align: center;
            padding: 50px;
            background-color: #212121;
            border-radius: 10px;
        }
        
        #login-section h2 {
            margin-bottom: 20px;
            color: var(--primary-text-color);
        }
        
        #login-section p {
            margin-bottom: 30px;
            color: var(--secondary-text-color);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: var(--primary-text-color);
            font-size: 1.5em;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .loading-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--success-color);
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 10;
            right: 30px;
            bottom: 30px;
            font-size: 17px;
        }
        
        #toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @-webkit-keyframes fadein {
            from {bottom: 0; opacity: 0;} 
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @-webkit-keyframes fadeout {
            from {bottom: 30px; opacity: 1;} 
            to {bottom: 0; opacity: 0;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        
        /* New Styles for Policy Section */
        #compliance-info a {
            text-decoration: none;
            font-weight: normal;
        }

    </style>
</head>
<body>
    <header>
        <h1>YouTube 視聴習慣アナライザー</h1>
        <p>視聴習慣を分析して、最適なチャンネル登録を見つけましょう。</p>
    </header>

    <div class="container">
        
        <div id="login-section" style="display: none;">
            <h2>アカウントを連携して分析を開始</h2>
            <p>「Googleでログイン」ボタンをクリックして、YouTubeアカウントのチャンネル登録情報の**取得、分析、登録解除**を許可してください。あなたのデータは安全に処理され、このアプリがあなたの許可なくチャンネル登録解除を行うことはありません。</p>
            <a href="/auth/google" class="btn-primary" style="padding: 12px 25px; display: inline-block;">
                <i class="fab fa-google"></i> Googleでログインして分析を開始
            </a>
        </div>
        
        <div id="app-section" style="display: none;">
            <div id="dashboard">
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>登録中のチャンネル</h3>
                        <p id="count-subscribed">0</p>
                    </div>
                    <div class="card" style="border-left: 3px solid var(--error-color);">
                        <h3>活動休止中</h3>
                        <p id="count-inactive">0</p>
                    </div>
                    <div class="card" style="border-left: 3px solid var(--success-color);">
                        <h3>活動中</h3>
                        <p id="count-active">0</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px;">
                    <h3 style="margin-bottom: 10px;">一括アクション</h3>
                    <button id="bulk-analyze-btn" class="btn-primary" disabled>
                        <i class="fas fa-chart-line"></i> 全チャンネルを分析
                    </button>
                    <button id="bulk-unsubscribe-btn" class="btn-danger" disabled style="margin-left: 10px;">
                        <i class="fas fa-trash"></i> 選択したチャンネルを一括解除
                    </button>
                    <span id="bulk-action-status" style="margin-left: 15px; color: var(--secondary-text-color);"></span>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px;">活動休止の基準 (最終投稿からN日)</h3>
                    <input type="range" id="inactive-threshold-slider" min="30" max="365" value="180" style="width: 100%;" disabled>
                    <p style="text-align: center; font-weight: bold;"><span id="threshold-display">180</span> 日以上</p>
                </div>
                
            </div>
            
            <div class="channel-list">
                <h2 style="margin-bottom: 15px;">登録チャンネル一覧 (<span id="channel-count">0</span>件)</h2>
                <div id="channel-items-container">
                    </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button id="logout-btn" class="btn-secondary">ログアウト</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>
    <div class="loading-overlay" id="loading-overlay">
        <i class="fas fa-spinner fa-spin"></i> 読み込み中...
    </div>

    <div id="compliance-info" style="max-width: 900px; margin: 50px auto 20px auto; padding: 20px; background-color: var(--surface-color); border-radius: 8px;">
        <h2 style="color: var(--button-blue-color); margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">プライバシーおよび利用規約情報 / Privacy & Terms Information</h2>

        <div style="margin-bottom: 20px;">
            <p style="font-size: 0.9em; margin-bottom: 5px;">
                本アプリを利用することで、ユーザーは
                <a href="https://www.youtube.com/t/terms" target="_blank" style="color: var(--button-blue-color); text-decoration: underline;">YouTube 利用規約</a> と
                <a href="http://www.google.com/policies/privacy" target="_blank" style="color: var(--button-blue-color); text-decoration: underline;">Google プライバシーポリシー</a>に同意したものとみなされます。
            </p>
            <p style="font-size: 0.8em; color: var(--secondary-text-color);">
                By using this app, users agree to be bound by the 
                <a href="https://www.youtube.com/t/terms" target="_blank" style="color: var(--button-blue-color); text-decoration: underline;">YouTube Terms of Service</a> and the 
                <a href="http://www.google.com/policies/privacy" target="_blank" style="color: var(--button-blue-color); text-decoration: underline;">Google Privacy Policy</a>.
            </p>
        </div>
        
        <section id="privacy-policy" style="margin-bottom: 30px; border-top: 1px solid var(--border-color); padding-top: 20px;">
            <h3 style="margin-bottom: 10px;">プライバシーポリシー / Privacy Policy</h3>
            
            <p style="margin-bottom: 15px;">
                本アプリ「YouTube 視聴習慣アナライザー」は、YouTube APIサービスを利用しています。
                (This app, "YouTube Viewing Habits Analyzer," utilizes YouTube API Services.)
            </p>
            
            <h4 style="margin-top: 10px;">アクセス、収集、利用するデータ (Data Accessed, Collected, and Used)</h4>
            <ul style="list-style-type: disc; margin-left: 25px; font-size: 0.9em; padding-left: 20px;">
                <li>**YouTubeチャンネル登録情報:** ユーザーが登録しているチャンネルのID、タイトル、サムネイル (User's subscribed channels: IDs, titles, thumbnails)</li>
                <li>**チャンネルの最新動画情報:** 登録チャンネルの最新の動画公開日時 (Latest video published date for frequency analysis)</li>
            </ul>
            
            <h4 style="margin-top: 10px;">データの利用目的と共有 (Purpose and Sharing)</h4>
            <p style="font-size: 0.9em;">
                これらのデータは、**ユーザーの視聴習慣を分析し、活動休止中のチャンネルを識別する**というアプリの機能を提供するためにのみ使用されます。データはサードパーティと共有されることは一切ありません。
                (This data is used solely to **analyze user viewing habits and identify inactive channels**, which is the core function of the app. The data is never shared with third parties.)
            </p>
        </section>

        <section id="data-deletion" style="margin-bottom: 30px; border-top: 1px solid var(--border-color); padding-top: 20px;">
            <h3 style="margin-bottom: 10px;">データの削除について / Data Deletion Procedure</h3>
            
            <p style="font-size: 0.9em;">
                本アプリは、永続的なサーバー側でのユーザーデータ（チャンネル登録情報など）の保存は行いません。セッションが切断されるか、ブラウザを閉じると、一時的なキャッシュデータは破棄されます。
                (This app does not store persistent user data on our servers. All temporary cached data is discarded when the browser session ends.)
            </p>
            <p style="margin-top: 10px; font-weight: bold;">
                本アプリへのアクセス権を取り消したい場合、またはGoogleと共有したデータのアクセス権を管理したい場合は、以下のGoogleセキュリティ設定ページからいつでも削除できます。
            </p>
            <p style="margin-top: 10px; text-align: center;">
                <a href="https://myaccount.google.com/connections?filters=3.4&hl=en" target="_blank" style="color: var(--error-color); font-weight: bold; text-decoration: underline; font-size: 1.1em;">Googleセキュリティ設定ページへ (Revoke Access via Google Security Settings)</a>
            </p>
        </section>

        <footer style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center;">
            <h4 style="margin-bottom: 5px;">お問い合わせ / Contact Information</h4>
            <p style="font-size: 0.9em;">
                何かご不明な点がございましたら、こちらにご連絡ください: <br>
                Email: <span style="color: var(--button-blue-color); font-weight: bold;">[tsukikage1258@gmail.com]</span>
            </p>
        </footer>
    </div>
    <script>
        // --- API Client ---
        const apiClient = {
            baseUrl: '', // Flaskルートを使用
            
            async checkAuthStatus() {
                const response = await fetch(`${this.baseUrl}/api/auth/status`);
                if (response.status === 200) {
                    return true;
                }
                return false;
            },
            
            async getAllChannels() {
                const response = await fetch(`${this.baseUrl}/api/all-channels`);
                if (!response.ok) throw new Error('チャンネル一覧の取得に失敗しました。');
                return response.json();
            },
            
            async analyzeChannel(channelId) {
                const response = await fetch(`${this.baseUrl}/api/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channelId })
                });
                if (!response.ok) throw new Error('チャンネル分析に失敗しました。');
                return response.json();
            },
            
            async unsubscribeChannel(subscriptionId) {
                const response = await fetch(`${this.baseUrl}/api/subscriptions/${subscriptionId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('チャンネル登録解除に失敗しました。');
                return response.json();
            },
            
            async bulkDeleteSubscriptions(subscriptionIds) {
                const response = await fetch(`${this.baseUrl}/api/subscriptions/bulk-delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscriptionIds })
                });
                if (!response.ok) throw new Error('一括解除に失敗しました。');
                return response.json();
            }
        };

        // --- Global State ---
        let allChannels = [];
        let uiState = {};
        
        // --- Utility Functions ---
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('visible');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('visible');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function isInactive(lastUploadDate, thresholdDays) {
            if (!lastUploadDate) return false; // 投稿が見つからない場合は非アクティブとしない

            const lastUpload = new Date(lastUploadDate);
            const today = new Date();
            const diffTime = Math.abs(today - lastUpload);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays >= thresholdDays;
        }
        
        function saveUiState() {
             uiState = {
                threshold: document.getElementById('inactive-threshold-slider').value,
                channels: allChannels // Save current analysis results
             };
             localStorage.setItem('youtubeAnalyzerState', JSON.stringify(uiState));
        }
        
        function loadUiState() {
             const savedState = localStorage.getItem('youtubeAnalyzerState');
             if (savedState) {
                 uiState = JSON.parse(savedState);
                 document.getElementById('inactive-threshold-slider').value = uiState.threshold || 180;
                 document.getElementById('threshold-display').textContent = uiState.threshold || 180;
                 allChannels = uiState.channels || [];
                 return true;
             }
             return false;
        }

        // --- Core Functions ---
        async function fetchChannels() {
            showLoading();
            try {
                const channels = await apiClient.getAllChannels();
                allChannels = channels.map(c => ({
                    ...c,
                    // 以前のセッションデータから分析結果を復元
                    lastUploadDate: (uiState.channels || []).find(sc => sc.channelId === c.channelId)?.lastUploadDate || 'pending'
                }));
                // 一旦、現在のチャンネルリストでUIを更新
                renderChannels();
                updateDashboard();
                updateBulkActionUI();
                saveUiState();
            } catch (error) {
                showToast(`エラー: ${error.message}`);
                console.error(error);
            } finally {
                hideLoading();
            }
        }
        
        async function startAnalysis() {
            showLoading();
            document.getElementById('bulk-analyze-btn').setAttribute('disabled', 'true');
            const statusElement = document.getElementById('bulk-action-status');
            statusElement.textContent = `0/${allChannels.length} チャンネル分析中...`;

            for (let i = 0; i < allChannels.length; i++) {
                const channel = allChannels[i];
                if (!channel.isSubscribed) continue; // 解除済みはスキップ

                try {
                    const result = await apiClient.analyzeChannel(channel.channelId);
                    channel.lastUploadDate = result.lastUploadDate;
                } catch (error) {
                    console.error(`Analysis failed for ${channel.channelName}:`, error);
                    channel.lastUploadDate = 'error';
                }

                // 進行状況を更新
                statusElement.textContent = `${i + 1}/${allChannels.length} チャンネル分析中...`;
                // 変更があったチャンネルのみ再レンダリング（パフォーマンスのため）
                renderChannelItem(channel.subscriptionId, channel);
            }
            
            statusElement.textContent = '分析完了！';
            document.getElementById('bulk-analyze-btn').removeAttribute('disabled');
            renderChannels(true); // フィルタリングのため全体を再レンダリング
            updateDashboard();
            saveUiState();
            hideLoading();
        }

        async function unsubscribeChannel(subscriptionId) {
            if (!confirm('このチャンネルの登録を解除しますか？')) return;

            showLoading();
            try {
                await apiClient.unsubscribeChannel(subscriptionId);
                const channel = allChannels.find(c => c.subscriptionId === subscriptionId);
                if (channel) {
                    channel.isSubscribed = false;
                    showToast(`${channel.channelName} の登録を解除しました。`);
                }
                renderChannels(true);
                updateDashboard();
                saveUiState();
            } catch (error) {
                showToast(`解除に失敗しました。: ${error.message}`);
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        // --- UI Rendering ---
        function updateDashboard() {
            const threshold = parseInt(document.getElementById('inactive-threshold-slider').value);
            const subscribedChannels = allChannels.filter(c => c.isSubscribed);
            
            const inactiveCount = subscribedChannels.filter(c => 
                isInactive(c.lastUploadDate, threshold)
            ).length;
            
            const activeCount = subscribedChannels.length - inactiveCount;
            
            document.getElementById('count-subscribed').textContent = subscribedChannels.length;
            document.getElementById('count-inactive').textContent = inactiveCount;
            document.getElementById('count-active').textContent = activeCount;
        }

        function updateBulkActionUI() {
            // Bulk analyze button should be enabled if we have channels to analyze
            if (allChannels.filter(c => c.isSubscribed).length > 0) {
                document.getElementById('bulk-analyze-btn').removeAttribute('disabled');
            } else {
                document.getElementById('bulk-analyze-btn').setAttribute('disabled', 'true');
            }
        }

        function getStatusBadge(channel) {
            const threshold = parseInt(document.getElementById('inactive-threshold-slider').value);
            if (!channel.isSubscribed) return `<span class="status-badge status-secondary">解除済み</span>`;
            
            if (channel.lastUploadDate === 'pending' || channel.lastUploadDate === 'error') {
                return `<span class="status-badge status-pending">${channel.lastUploadDate === 'error' ? 'エラー' : '分析待ち'}</span>`;
            }

            const isChanInactive = isInactive(channel.lastUploadDate, threshold);
            const date = new Date(channel.lastUploadDate);
            const dateStr = date.toLocaleDateString('ja-JP');
            const diffTime = Math.abs(new Date() - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (isChanInactive) {
                return `<span class="status-badge status-inactive">活動休止 (${diffDays}日)</span>`;
            } else {
                return `<span class="status-badge status-active">活動中 (${dateStr})</span>`;
            }
        }
        
        function createChannelItemHtml(channel) {
            return `
                <div class="channel-item ${!channel.isSubscribed ? 'unsubscribed' : ''}" data-subscription-id="${channel.subscriptionId}" id="channel-${channel.subscriptionId}">
                    <input type="checkbox" class="channel-checkbox" data-subscription-id="${channel.subscriptionId}" ${!channel.isSubscribed ? 'disabled' : ''}>
                    <img src="${channel.thumbnailUrl}" alt="${channel.channelName} thumbnail">
                    <div class="channel-info">
                        <h4>${channel.channelName}</h4>
                        <p>${channel.channelId}</p>
                    </div>
                    ${getStatusBadge(channel)}
                    <div class="action-buttons">
                        <button class="btn-primary btn-analyze" data-channel-id="${channel.channelId}" data-subscription-id="${channel.subscriptionId}">
                            <i class="fas fa-search"></i> 分析
                        </button>
                        <button class="btn-danger btn-unsubscribe" data-subscription-id="${channel.subscriptionId}" ${!channel.isSubscribed ? 'disabled' : ''}>
                            <i class="fas fa-user-minus"></i> 解除
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderChannelItem(subscriptionId, channel) {
            const container = document.getElementById('channel-items-container');
            const existingElement = document.getElementById(`channel-${subscriptionId}`);
            if (existingElement) {
                // 既存の要素を更新
                existingElement.outerHTML = createChannelItemHtml(channel);
            } else if (container) {
                // 新しい要素を追加
                container.innerHTML += createChannelItemHtml(channel);
            }
        }

        function renderChannels(shouldReattachListeners = false) {
            const container = document.getElementById('channel-items-container');
            if (!container) return;

            // Sort channels: Subscribed, then Inactive, then Active, then Unsubscribed
            const threshold = parseInt(document.getElementById('inactive-threshold-slider').value);
            const sortedChannels = [...allChannels].sort((a, b) => {
                const aSub = a.isSubscribed;
                const bSub = b.isSubscribed;
                
                if (aSub && !bSub) return -1;
                if (!aSub && bSub) return 1;
                if (!aSub && !bSub) return 0; // 両方解除済みなら順序変更なし

                const aInactive = isInactive(a.lastUploadDate, threshold);
                const bInactive = isInactive(b.lastUploadDate, threshold);

                if (aInactive && !bInactive) return -1;
                if (!aInactive && bInactive) return 1;
                return a.channelName.localeCompare(b.channelName); // 名前でソート
            });

            container.innerHTML = sortedChannels.map(createChannelItemHtml).join('');
            document.getElementById('channel-count').textContent = allChannels.filter(c => c.isSubscribed).length;
            
            if (shouldReattachListeners) {
                attachChannelListeners();
            }
        }

        function attachChannelListeners() {
            // Remove previous listeners if any to prevent duplicates
            const container = document.getElementById('channel-items-container');
            if (container) {
                container.removeEventListener('click', handleChannelActions);
            }

            // Attach new listeners
            if (container) {
                container.addEventListener('click', handleChannelActions);
            }
        }

        function handleChannelActions(event) {
            const target = event.target.closest('button');
            if (!target) return;

            const subscriptionId = target.dataset.subscriptionId;
            const channelId = target.dataset.channelId;

            if (target.classList.contains('btn-analyze')) {
                const channel = allChannels.find(c => c.subscriptionId === subscriptionId);
                if (channel) {
                     // 1つだけ分析を実行
                     showLoading();
                     apiClient.analyzeChannel(channelId)
                        .then(result => {
                            channel.lastUploadDate = result.lastUploadDate;
                            renderChannelItem(subscriptionId, channel); // 個別更新
                            updateDashboard();
                            saveUiState();
                            showToast(`${channel.channelName} の分析が完了しました。`);
                        })
                        .catch(error => {
                            showToast(`分析エラー: ${error.message}`);
                            channel.lastUploadDate = 'error';
                            renderChannelItem(subscriptionId, channel); // エラー表示を更新
                        })
                        .finally(() => {
                            hideLoading();
                        });
                }
            } else if (target.classList.contains('btn-unsubscribe')) {
                unsubscribeChannel(subscriptionId);
            }
        }


        // --- Initialization ---
        async function checkAuthStatus() {
            const isAuth = await apiClient.checkAuthStatus();
            if (isAuth) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('app-section').style.display = 'block';
                // 状態をロードしてからチャンネルを取得
                loadUiState(); 
                // 認証済みならチャンネルデータを取得
                await fetchChannels();
                
                // イベントリスナーの再設定
                attachChannelListeners();
            } else {
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('app-section').style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Event Listeners
            document.getElementById('inactive-threshold-slider').addEventListener('input', (e) => {
                document.getElementById('threshold-display').textContent = e.target.value;
                renderChannels(true); // Re-render to reflect new filter
                updateDashboard();
                saveUiState();
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                // ログアウト処理（セッションクリアはサーバー側で行うのが理想だが、ここではクライアント側の状態をクリア）
                localStorage.removeItem('youtubeAnalyzerState');
                window.location.href = '/logout'; // ログアウトルートをサーバーに追加するのが理想
            });
            
            document.getElementById('bulk-analyze-btn').addEventListener('click', startAnalysis);

            document.getElementById('bulk-unsubscribe-btn').addEventListener('click', async () => {
                const checkboxes = document.querySelectorAll('.channel-checkbox:checked');
                const subscriptionsToUnsubscribe = Array.from(checkboxes).map(cb => cb.dataset.subscriptionId);
                
                if (subscriptionsToUnsubscribe.length === 0) {
                    alert('解除するチャンネルを選択してください。');
                    return;
                }

                if (!confirm(`${subscriptionsToUnsubscribe.length}件のチャンネルを一括解除しますか？ この操作は元に戻せません。`)) {
                    return;
                }

                document.getElementById('bulk-action-status').innerHTML = `<i class=\"fas fa-spinner fa-spin\"></i> 解除中...`;
                try {
                    const result = await apiClient.bulkDeleteSubscriptions(subscriptionsToUnsubscribe);
                     // Reflect changes in the UI based on which channels were successfully unsubscribed.
                     // The backend might not return which ones succeeded, so we assume all did for simplicity here.
                     // A more robust implementation would have the backend return the list of successful IDs.
                    subscriptionsToUnsubscribe.forEach(subId => {
                        const channel = allChannels.find(c => c.subscriptionId === subId);
                        if (channel) {
                            channel.isSubscribed = false;
                        }
                    });
                    showToast(`${subscriptionsToUnsubscribe.length}件のチャンネルを解除しました。`);
                } catch (error) {
                    console.error("Bulk unsubscribe failed:", error);
                    alert(`一括解除に失敗しました: ${error.message}`);
                } finally {
                   renderChannels(true); // Full re-render to reflect all changes
                   updateDashboard();
                   updateBulkActionUI();
                }
            });

            // Save state on page unload
            window.addEventListener('beforeunload', saveUiState);

            // --- INITIALIZATION ---
            checkAuthStatus();
        });
    </script>
</body>
</html>

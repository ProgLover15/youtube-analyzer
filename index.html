<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>視聴習慣アナライザー for YouTube</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* あなたが作成したダッシュボードのデザインを100%再現 */
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --secondary-text: #aaaaaa;
            --blue: #3ea6ff;
            --accent-red: #cc4141;
            --border: #333;
        }
        body { font-family: sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
        .stats-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 8px; text-align: center; border: 1px solid var(--border); }
        .stat-card .value { font-size: 28px; font-weight: bold; }
        .main-panel { background: var(--card-bg); border-radius: 12px; padding: 25px; border: 1px solid var(--border); }
        .slider-container { display: flex; align-items: center; gap: 15px; margin: 20px 0; }
        input[type="range"] { flex: 1; accent-color: var(--blue); }
        .filter-group { display: flex; gap: 10px; margin-bottom: 25px; }
        .filter-btn { background: #333; border: none; color: white; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .filter-btn.active { background: var(--blue); }
        .action-bar { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .btn-bulk-delete { background: var(--accent-red); border: none; color: white; padding: 10px 24px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .channel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .channel-card { background: #252525; padding: 20px; border-radius: 10px; border: 1px solid #333; transition: 0.3s; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .channel-thumb { width: 60px; height: 60px; border-radius: 50%; }
        .last-upload { font-size: 13px; color: var(--secondary-text); border-top: 1px solid #444; padding-top: 15px; margin-top: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="onboarding" class="hidden" style="text-align: center; padding-top: 100px;">
        <h1>視聴習慣アナライザー for YouTube</h1>
        <a href="/auth/google" style="display: inline-block; background: white; color: black; padding: 15px 40px; border-radius: 4px; text-decoration: none; font-weight: bold; margin-top: 30px;">Googleでサインイン</a>
    </div>

    <div id="dashboard" class="hidden">
        <header style="margin-bottom: 30px;">
            <h1>視聴習慣アナライザー for YouTube</h1>
        </header>

        <div class="stats-container">
            <div class="stat-card"><div class="value" id="total-count">0</div><div class="label">登録中</div></div>
            <div class="stat-card"><div class="value" id="inactive-count">0</div><div class="label">活動休止中</div></div>
            <div class="stat-card"><div class="value">0</div><div class="label">登録解除済み</div></div>
            <div class="stat-card"><div class="value" style="color: #4caf50;">✓</div><div class="label">分析完了</div></div>
        </div>

        <div class="main-panel">
            <h3><i class="fas fa-bed"></i> 登録チャンネル一覧</h3>
            <div class="slider-container">
                <span>活動休止の基準</span>
                <input type="range" id="days-slider" min="30" max="365" value="60">
                <span id="days-value">60日</span>
            </div>

            <div class="filter-group">
                <button class="filter-btn active">すべて</button>
                <button class="filter-btn">活動休止中</button>
                <button class="filter-btn">活動中</button>
                <button class="filter-btn">分析待ち</button>
            </div>

            <div class="action-bar">
                <label><input type="checkbox" id="select-all"> すべて選択</label>
                <button class="btn-bulk-delete" onclick="bulkDelete()">選択したチャンネルを登録解除</button>
            </div>

            <div id="channel-grid" class="channel-grid"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // app.pyの認証状態確認APIを使用
            const authRes = await fetch('/api/auth/status');
            const authData = await authRes.json();
            
            if (authData.status === 'authenticated') {
                document.getElementById('dashboard').classList.remove('hidden');
                loadChannels();
            } else {
                document.getElementById('onboarding').classList.remove('hidden');
            }
        });

        async function loadChannels() {
            const grid = document.getElementById('channel-grid');
            // app.pyの全チャンネル取得APIを使用
            const res = await fetch('/api/all-channels');
            const channels = await res.json();
            document.getElementById('total-count').innerText = channels.length;

            channels.forEach(ch => {
                const card = document.createElement('div');
                card.className = 'channel-card';
                card.innerHTML = `
                    <div class="card-header">
                        <img src="${ch.thumbnailUrl}" class="channel-thumb">
                        <input type="checkbox" class="ch-checkbox" data-id="${ch.subscriptionId}">
                    </div>
                    <div style="font-weight: bold; margin-bottom: 10px;">${ch.channelName}</div>
                    <div class="last-upload" id="date-${ch.channelId}">解析中...</div>
                `;
                grid.appendChild(card);

                // 各チャンネルの最終投稿日を個別解析
                fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ channelId: ch.channelId })
                })
                .then(r => r.json())
                .then(data => {
                    const el = document.getElementById(`date-${ch.channelId}`);
                    if (data.lastUploadDate) {
                        const days = Math.floor((new Date() - new Date(data.lastUploadDate)) / (1000*60*60*24));
                        el.innerText = `最終投稿: ${days}日前`;
                        if (days > document.getElementById('days-slider').value) {
                            el.style.color = '#ff4d4d'; // 休止中の色
                        }
                    } else {
                        el.innerText = '最終投稿: 記録なし';
                    }
                });
            });
        }

        document.getElementById('days-slider').oninput = function() {
            document.getElementById('days-value').innerText = this.value + '日';
        };

        async function bulkDelete() {
            const selected = Array.from(document.querySelectorAll('.ch-checkbox:checked')).map(cb => cb.dataset.id);
            if (selected.length === 0) return alert('解除するチャンネルを選択してください。');
            if (!confirm(`${selected.length}件の登録を解除しますか？`)) return;

            // app.pyの一括削除APIを使用
            const res = await fetch('/api/subscriptions/bulk-delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ subscriptionIds: selected })
            });
            if (res.ok) {
                alert('解除が完了しました。');
                location.reload();
            }
        }
    </script>
</body>
</html>
